<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Solve the maze from Coding Quest 2024">
  <title>Mining Tunnels</title>
  <style>
body {
  margin: 0;
  overflow: hidden;
}
canvas.maze {
  width: 100vw;
  height: 100vh;
  display: block;
}
canvas.map1, canvas.map2 {
  position: absolute;
  width: 30vw;
  aspect-ratio: 1;
  bottom: 0;
  right: 0;
  margin: 2rem;
  transition-property: translate, opacity;
  transition-duration: 1s;
  transition-delay: 0s;
  pointer-events: none;
}
canvas.map1.hidden, canvas.map2.hidden {
  opacity: 0;
  transition-delay: 300ms;
}
canvas.map1.hidden {
  translate: 0 50%;
}
canvas.map2.hidden {
  translate: 0 -50%;
}
aside {
  position: absolute;
  right: 0;
  margin: 1rem;
}
input {
  accent-color: deeppink;
}
p {
  margin-block: 0.5rem;
}
a {
  color: deeppink;
}
  </style>
  <script id="vertexShader" type="x-shader/x-vertex">
#version 300 es

uniform mat4 u_projectionMatrix;
uniform vec3 u_cameraPosition;
uniform vec3 u_cameraTarget;

in vec4 a_position;
in vec4 a_color;
in vec2 a_texcoord;

out vec4 v_color;
out vec2 v_texcoord;

void main() {
  vec3 up = vec3(0., 1., 0.);
  vec3 zaxis = normalize(u_cameraPosition - u_cameraTarget);
  vec3 xaxis = normalize(cross(up, zaxis));
  vec3 yaxis = normalize(cross(zaxis, xaxis));
  mat4 cameraMatrix = mat4(xaxis, 0., yaxis, 0., zaxis, 0., u_cameraPosition, 1.);
  mat4 u_viewMatrix = inverse(cameraMatrix);

  gl_Position = u_projectionMatrix * u_viewMatrix * a_position;
  v_color = a_color;
  v_texcoord = a_texcoord;
}
  </script>
  <script id="fragmentShader" type="x-shader/x-fragment">
#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform bool u_usingTexture;

in vec4 v_color;
in vec2 v_texcoord;

out vec4 fragColor;

void main() {
  fragColor = u_usingTexture ? texture(u_texture, v_texcoord) : v_color;
}
  </script>
  <script type="module">
const gl = document.querySelector('canvas.maze').getContext('webgl2', { premultipliedAlpha: false });
const map1 = document.querySelector('canvas.map1').getContext('2d');
const map2 = document.querySelector('canvas.map2').getContext('2d');
const minimapCheckbox = document.querySelector('input.minimap');
const textureCheckbox = document.querySelector('input.texture');

const program = gl.createProgram();
function createShader(type, source) {
  const shader = gl.createShader(type);
  gl.shaderSource(shader, source);
  gl.compileShader(shader);
  if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
    try {
      throw gl.getShaderInfoLog(shader);
    } finally {
      gl.deleteShader(shader);
    }
  }
  return shader;
}
gl.attachShader(program, createShader(gl.VERTEX_SHADER, document.getElementById('vertexShader').text.trim()));
gl.attachShader(program, createShader(gl.FRAGMENT_SHADER, document.getElementById('fragmentShader').text.trim()));
gl.linkProgram(program);
if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
  try {
    throw gl.getProgramInfoLog(program);
  } finally {
    gl.deleteProgram(program);
  }
}
gl.useProgram(program);
gl.bindVertexArray(gl.createVertexArray());
gl.clearColor(0, 0, 0, 0);
gl.enable(gl.DEPTH_TEST);
gl.enable(gl.CULL_FACE);

function setAttribute(attribute, array, size, normalize = false, type = gl.FLOAT, usage = gl.STATIC_DRAW) {
  const attribLocation = gl.getAttribLocation(program, attribute);
  gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
  gl.bufferData(gl.ARRAY_BUFFER, array, usage);
  gl.enableVertexAttribArray(attribLocation);
  gl.vertexAttribPointer(attribLocation, size, type, normalize, 0, 0);
}

function resizeCanvas() {
  gl.canvas.width = gl.canvas.clientWidth;
  gl.canvas.height = gl.canvas.clientHeight;
  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
  gl.uniformMatrix4fv(gl.getUniformLocation(program, 'u_projectionMatrix'), false, new Float32Array([
    Math.sqrt(3) * gl.canvas.height / gl.canvas.width, 0, 0, 0,
    0, Math.sqrt(3), 0, 0,
    0, 0, -1, -1,
    0, 0, -0.0001,  0,
  ]));
}
resizeCanvas();

let keys = new Map();
addEventListener('keydown', e => {
  if (e.repeat) { return; }
  keys.set(e.key.toUpperCase(), true);
  keys.delete(({
    'ARROWLEFT': 'ARROWRIGHT',
    'ARROWRIGHT': 'ARROWLEFT',
    'ARROWUP': 'ARROWDOWN',
    'ARROWDOWN': 'ARROWUP',
    'W': 'S',
    'S': 'W',
    'A': 'D',
    'D': 'A',
  })[e.key.toUpperCase()]);
});
addEventListener('keyup', e => {
  keys.delete(e.key.toUpperCase());
});

let vertices = [];
let colors = [];
let texcoords = [];
let count = 0;

let walls = [];
let elevators = [];
let elevatorVs = [];

let position = [-1, 0.5, 1.5];
let angle = Math.PI/2;
let swapping = false;
let ground = true;
let covered = [];

let maze1 = [];
let maze2 = [];

function resetMazes(test) {
  vertices = [];
  colors = [];
  texcoords = [];
  count = 0;
  
  walls = [];
  elevators = [];
  elevatorVs = [];

  position = [-1, 0.6, 1.5];
  angle = Math.PI/2;
  swapping = false;
  ground = true;
  covered = [];

  maze1 = (test ? 
`#####################
................#...#
###########.###.#.#.#
#...#.......#.#...#.#
#.#.#.#######.#####.#
#.#..$#.#.$....$....#
#.#####.#.#######.###
#.#.......#.....#.#.#
#.#########.###.#.#.#
#.#...........#.#...#
#.#.#$####$.###$###.#
#...#.....#.#...#...#
#.###.###.###.#.#.###
#...#.#.....#.#.#...#
#####################
#.#.#$..#.$...#$..#.#
#.#.###.###.#.#.###.#
#...#...#...#.....#.#
#.###.###.#.#####.#.#
#...#.....#..........
#####################`
  :
`#####################################################################################################
......#.....#.#.......#.....#.....#.....#.#.................#...............#.............#.#.......#
#.###.#.#.#.#.#.#####.#.#.#.#.###.###.#.#.#.#######.#######.#########.#####.#.#####.#####.#.#.###.#.#
#.#.#...#.#.#.#.#...#...#.#...#.#.....#.#.#...#...#.#...#.....#.....#.#...#.#.#...#.#...#.#...#...#.#
#.#.#####.#.#.#.#.#.#####.#####.#######.#.###.#.#.#.#.#.#.###.#.###.#.#.#.#.#.#.#.#.#.#.#.#.###.#####
#...#$..#.$...#$#.#.$.#.#$..#.$....$..#.$....$#.#.$.#.#$..#.$.#.#$..#.$.#..$..#.$...#$#.#.$.#.#$#...#
###.#.#.#.#####.#.###.#.###.#.#######.#.###.###.#####.#####.###.#.###.###.###.#.#####.###.#.#.#.#.#.#
#.#...#.#.......#...#...#...#.......#.#...#...#...#...#...#.....#.#.....#.#...#.#.....#...#...#.#.#.#
#.#####.#########.#.#####.#.#########.###.#######.#.#.#.#.#######.###.#.###.###.#.#.#.#.#####.#.#.#.#
#.....#.#.#.......#...#...#.#...#...#...#...#.....#.#.#.#.#.....#...#.#...#.#.#.#.#.#.#.....#.#...#.#
#.###$#.#.$.###$####$.#.#$###.$.#.#$#.#.$##.#$####$.#.#$#.#.$.#.#$#.##$##.#$#.#.$##.#$####$.#.#$###.#
#...#...#.......#...#.#.......#.#.#.#.#...#.#.#.....#...#...#.#...#.#...#.....#.#...#.....#.#...#.#.#
###.#####.#####.#.#.#.#########.#.#.#.#.#.#.#.#########.#####.#####.#.#.#######.#.#.#.#.###.###.#.#.#
#.#.#.....#...#.#.#...#...#...#.#.#.#.#.#.#.#.#...#...#...#.#...#...#.#.......#.#.#.#.#...#...#...#.#
#.#.#.#####.#.###.###.#.#.#.#.#.#.#.###.###.#.#.#.#.#.###.#.###.#.###.#######.#.#.#.#.###.###.#####.#
#.#.#$#...$.#..$#.#.$.#.#$#.#.$.#.#$#...$...#$..#.$.#..$#.#.$.#..$#...$.#.#$..#.$.#.#$#.#.$...#$....#
#.#.#.#.#######.#.#.###.#.#.#####.#.#.#.#.#####.#######.#.#.#.#########.#.#.###.#.#.#.#.#.#.###.###.#
#.#.#.#...#...#.#.#.....#.#.#.....#.#.#.#.....#.#.#...#.#...#...........#.#.....#.#.#...#.#...#.#...#
#.#.#####.#.#.#.#.#########.#.#####.#.#.#####.#.#.#.#.#.#################.#######.#.###.#.###.#.###.#
#.#.#.....#.#.....#.......#...#.....#.#.....#.#.#...#.#...#...#...#...#.#.........#.#...#...#.#...#.#
#.#.#$####$.###$###.$####$####$.###$#.##$####$#.##$##.#$#.#.$.#.#$#.#.$.#.#$####$.###$####$.#.#$#.###
#.#.#.#...#.#.......#.#...#...#...#...........#.....#.#...#.#...#...#.#.......#.#.....#...#...#.#...#
#.#.#.###.#.#.#######.#.###.#.###.#######.#########.#.#.###.#########.#######.#.#######.#.#####.###.#
#.#.#...#...#.....#...#.....#...#.......#.#...#.......#.#...#.......#...#...#...#.......#...#.....#.#
#.#.#.#.#.#######.#.###########.###.###.#.#.#.#.#######.#.###.#.#######.#.#.###.#####.#####.#####.#.#
#...#$#.#.$...#$..#.$.#..$#...$...#$#.#.$...#$#...$...#$#...$.#..$....$.#.#$#...$...#$#...$...#$#.#.#
#.#####.###.#.#.###.#.#.#.#.#.###.#.#.#.#####.#####.#.#.###.#########.#.#.#.###.#.#.#.#.#####.#.#.#.#
#.#.....#...#...#...#...#...#...#.#...#.#...#.......#.#...#...#...#...#...#...#...#...#.......#...#.#
#.#.#.#.#.#######.#########.###.#.#####.#.###########.#.#.###.#.#.#.#########.#########.#######.###.#
#.#.#.#.#.......#.#...#...#...#.#.......#...........#.#.#...#.#.#...#.......#...#...#...#.........#.#
#.###$#.##$####$#.#.$.#.#$####$.###$####$.###$###.$##.#$###.$.#.#$###.$####$###.$.###$###.$####$###.#
#.....#.#.....#.#...#.#.#...#.......#...#.......#...#...#.#.#...#.#...#...#.....#...#.#.....#.......#
#######.###.#.#.#######.###.#.#####.#.#.###.#####.#.#####.#.###.###.###.#.#########.#.#.#####.#####.#
#.#.....#...#.#.#.......#.#.#...#.....#.#...#...#.#.#.....#.#...#...#...#...........#.#.#...#.#.#...#
#.#.#####.###.#.#.#######.#.###.#.#####.#####.#.###.#.#.###.#.###.###############.###.#.#.#.#.#.#.###
#.#.#$....$...#$#...$....$#.#.$.#.#$..#.$...#$#...$.#.#$..#.$.#.#$#...$....$....$....$#.#.$...#$..#.#
#.#.#.###.#.###.###.#######.#.#####.#.#####.#.#######.###.#.#.#.#.#.###########.#.#######.#####.###.#
#...#.#.#.#...#.....#.......#.......#.#.......#.....#...#...#.#.#.#.......#.#...#.#.....#...#.......#
#.###.#.#.###########.#####.#####.###.#####.###.###.###.#####.#.#.#######.#.#.###.#.###.#.#.#######.#
#.#.#.#.#.#...#.....#...#...#...#...#.....#.#...#.#...#.#...#.#.#.......#...#.#.....#...#.#.#.....#.#
#.#.#$#.#.$.#.#$###.$##.#$#.#.$.###$###.$.#.#$###.$.###$#.#.$.#.#$###.$####$#.##$####$###.$.#.#$#.#.#
#.#.....#.#.#.#.#...#.#...#.#.#...#...#.#.#.#.....#.#.....#.#...#...#.......#.#...#.#...#.#.#.#...#.#
#.#######.#.#.#.#.#.#.###.###.###.#.#.###.#.#####.#.#.#####.###.#.#.###.#####.#.#.#.###.###.#.#.###.#
#...#.....#.#...#.#...#.#.....#.#...#...#.#.#.....#...#...#...#.#.#...#.#...#.#.#.#...#...#...#.#...#
###.#.#####.#####.###.#.#######.#######.#.###.#########.#.#####.#.###.#.#.#.#.#.#.#.#.###.#.###.#.###
#.#.#$....$...#$..#.$.#..$..#.$....$..#.$.#..$#...$.#.#$#.#.$...#$..#.$.#.#$#...$.#.#$..#.$.#..$#.#.#
#.#.#.###.###.#.###.#.###.#.#.###.###.#.#.#.###.###.#.#.#.#.#######.#.###.#.#####.#.#####.#.#.###.#.#
#.#.#...#...#.#.#...#.....#.#.#...#...#.#...#...#...#.#.#...#.....#.#.....#.......#.......#.#.#.....#
#.#.#####.#.#.#.#.#########.#.#.#####.#.###.#.#####.#.#.#####.#####.###############.#########.#####.#
#.#.....#.#.#.#.#.......#...#.#.....#.#...#...#...#...#...#.....#...#.....................#...#...#.#
#.###$#.#.$##.#$###.$.###$###.$####$#.##$.###$#.#.$##.#$#.#.$##.#$###.$####$###.$####$###.$.#.#$#.#.#
#.....#.#.....#...#.#.#...#.#.#...#.#...#.......#...#...#.#.#...#.#.....#.....#...#.....#.#.#.#.#.#.#
#.#.###.#####.###.#.#.#.###.#.#.#.#.###.###########.###.#.###.###.#####.#.###.#####.###.#.#.###.#.###
#.#...#.#...#.#...#.#.#.#.....#.#.#...#...#...#...#...#.#...#...#.....#.#...#.........#.#...#...#...#
#.###.#.#.#.###.###.#.#.#####.#.#####.###.#.#.###.###.#.###.###.#####.###.###########.#.#####.#####.#
#.#.#$..#.$....$#...$.#.#$..#.$....$#...$...#$....$...#$..#.$.#..$#.#.$...#$....$...#$#.#.$...#$....#
#.#.#####.#######.###.#.#.#.#.#####.###.#########.#.#########.#.#.#.#######.#######.#.#.#.#####.###.#
#.#.....#.....#.#.#.#...#.#.#.#.....#.#.#.......#.#.#...#...#.#.#.......#...#.....#.#.#.....#...#.#.#
#.###.#.#####.#.#.#.#####.#.#.#.###.#.#.###.#####.#.#.#.#.#.#.#.#########.###.###.#.#########.###.#.#
#.....#.......#.#.......#.#.#...#.#.#.#...#.#.....#.#.#.#.#.#.#...#.......#...#...#...........#.#...#
#####$####$####$####$##.#$#.##$##.#$#.##$.#.#$####$.#.#$#.#.$.###$#.##$####$####$####$####$####$#.###
#.........#...#.......#...#.#.....#.....#.#.#.#...#...#...#...#...#...#.....#...................#.#.#
#.#.#####.#.#.#.#.#########.#.#.#####.###.#.#.#.#.###########.#.#####.#.#####.###.#############.#.#.#
#.#...#.#...#.#.#.#...#.....#.#.....#.#...#...#.#.......#...#...#.....#...#...#.#.....#...#...#.#...#
#####.#.#####.#.#.#.#.#.#########.#.#.#.#######.#######.#.#.#####.#######.#.###.#####.#.#.#.#.#####.#
#....$#.#.$.#..$#.#.$...#$....$...#$#.#.$....$..#.$....$#.#.$....$#...$...#$....$...#$..#.$.#..$..#.#
#.#####.#.#.#####.#.#####.###.#######.#.#.#######.#.#####.#########.#####.#####.#.#.#####.#.###.###.#
#.#.......#.....#.#.#...#.#.#.....#...#.#.#.......#.......#.............#...#...#.#.....#.#...#...#.#
#.###.#####.#####.#.###.#.#.#####.#.###.#.#.###.#.#########.###########.#####.#######.#.#.#.#####.#.#
#...#...#.#.......#...#.#...#...#.....#.#.#...#.#.....#...#.#.........#.#.....#.......#.#.#.#.....#.#
#.#.#$#.#.$####$####$.#.#$###.$.#.#$###.$.###$#.##$##.#$#.#.$.###$###.$.#.#$###.$####$#.#.$.#.#$#.#.#
#.#.#...#...........#.#...#...#.#...#...#.#...#.....#...#.#.#.......#.#...#.....#...#...#...#.#...#.#
#.#.#.###.#.#####.###.#.###.###.#####.#.#.#########.###.###.#######.###.###.###.#.#.#.#######.#.###.#
#.#.#.....#.#...#.#...#...#...#.#.....#.#.#.....#...#...#...#...#.#.#...#...#.#.#.#.#.....#...#.#...#
#.#.#########.#.###.#########.#.#.#####.#.#.###.#.#######.###.#.#.#.#.###.###.#.#.#.#######.#####.###
#.#..$#...$...#$....$....$#...$.#.#$..#.$...#$..#.$....$..#.$.#..$#.#.$.#..$#...$.#..$....$....$#...#
#####.#.#############.###.#.###.#.#.#.#.#####.###.#.#########.###.#.###.#.#.#.###.#######.#.###.###.#
#.....#.#...#.........#.#.#...#.#...#.#...#...#...#.....#.....#...#...#.#.#.#.#.#.#...#...#.#.....#.#
#.#.###.#.#.#.#########.#.#.#.#.#####.###.#.###.#######.#.###########.#.###.#.#.#.###.#.#####.#####.#
#.#.#.....#...#.........#.#.#.#.......#...#.#.........#.#...#.........#.....#...#...#.#.#.....#...#.#
#.###$####$####$####$##.#$###.$####$####$##.#$####$##.#$###.$.###$####$##.#$####$.#.#$#.#.$####$#.#.#
#.....#.......#.#.....#.#.....#.....#.......#.#.......#...#.#.....#.#.....#.....#.#.#...#.#...#.#...#
#######.#####.#.#.###.#####.#####.###.#######.#.#########.#.#####.#.#.#####.###.#.#.#.###.#.#.#.#####
#...#...#...#.#.#...#.......#...#.#...#.......#...........#.....#.#...#.....#.#.#.#.#...#.#.#.#...#.#
#.#.#.###.###.#.###.#########.#.###.#########.#############.#.#.#.#.###.#####.#.#.#.###.#.#.#.###.#.#
#.#..$#...$...#$#...$.#..$#...$...#$#...$...#$....$.#..$..#.$.#.#$#.#.$.#..$#...$.#.#$#.#.$.#..$..#.#
#.#####.#.#.###.#.#####.#.#.#####.#.#.#####.#######.#.###.###.#.#.###.###.#.#.#####.#.#.#.#.#######.#
#...#.#.#...#.....#.#...#.#.#...#.#...#.....#.......#...#.#...#.#...#.#...#.#.......#...#.#.#.....#.#
#.#.#.#.#########.#.#.###.#.#.#.#.#####.#####.#######.#.#.#.#######.#.#.###.###.#####.###.#.###.#.#.#
#.#.#.#.#.......#...#.#.#...#.#...#.....#...#.....#...#.#...#...#...#.....#...#.#...#.....#.....#.#.#
###.#$#.#.$####$####$.#.#$###.$####$####$.#.#$###.$.###$####$.#.#$###.$####$#.##$.#.#$####$####$#.#.#
#...#.....#.........#.#.#.....#...#.#.#...#...#...#...#.#.....#...#.#.#.....#.#...#.#.........#...#.#
#.#########.#######.#.#.#.#####.#.#.#.#.###.###.#######.#.#########.#.#.###.#.#.###.#.#####.#.#.###.#
#.......#...#.....#...#...#.....#...#.#.#.#.........#...#.....#.......#.#.#...#.#...#.#.#...#.#.#...#
#.#####.#####.###.#####.#######.#####.#.#.#########.#.#######.###.#####.#.###.#.#.#.#.#.#.#####.#.#.#
#...#$..#.$...#$..#.$.#..$..#.$.#..$....$...#$..#.$...#$....$...#$#.#.$.#..$..#.$.#.#$#.#.$....$#.#.#
###.#.#.#.#####.###.#.#####.#.###########.###.#.#####.#.#.#####.#.#.#.###.#####.#.###.#.#########.#.#
#...#.#.#.#...#.....#.....#...#.....#...#.#...#.#...#.#.#...#...#.#.....#.#.....#...#.#.......#...#.#
#.###.###.#.#.###########.#####.###.#.#.###.###.#.#.###.###.#.###.#.###.###.#######.#.#.#####.#.###.#
#...#.......#...........#.........#...#.......#...#.......#...#.......#...........#.....#.......#....
#####################################################################################################`
  ).split('\n').map(l=>l.split(''));

  maze2 = (test ?
`#####################
#.........#.........#
#.###.###.#########.#
#.......#...........#
#######.###########.#
#....$#...$....$....#
#.###.#####.#######.#
#.#.........#.......#
#.#####.#.#.#.#####.#
#...#...#.#.#.#...#.#
###.#$###.$.#.#$#.#.#
#...#.#.#.#...#.#.#.#
#.#.#.#.#.###.#.#.#.#
#.#.....#.........#.#
#.#####.###.#####.#.#
#....$#...$.#..$..#.#
#.###.#.###.#.#####.#
#...#...#.....#.....#
###.#####.#####.#####
#.......#...........#
#####################`
  :
`#####################################################################################################
#.........#.........#...#.................#.....#.....#...........#...#.....#.....#...........#.....#
#####.###.#.#######.#.#.###.###.###########.#.###.#.#.###.#######.###.#.#.#.###.#.#####.#.###.#.###.#
#.....#...#.......#...#...#...#.#...#.......#.....#.#...#.....#.#...#...#.#...#.#.....#.#.#.....#.#.#
#.###############.#######.###.###.#.#.#############.###.#####.#.###.#####.###.#.#####.#.#.#.#####.#.#
#....$#...$....$#...$.#.#$..#.$...#$..#.$...#$....$...#$..#.$.#..$#...$...#$..#.$....$#.#.$.#..$#.#.#
#####.#.#.#.###.#####.#.###.#.#############.#.###.#.#.###.#.###.###.#######.###.#.#####.#.###.#.#.#.#
#.....#.#.....#.....#.#...#.#.....#.........#...#.#.#.#...#.#.......#...#.......#...#...#.#...#.#...#
#.###.#.#########.###.###.#.#####.###.###.#####.#.###.#.###.###.#####.#.###########.#####.#.###.#.###
#.#...#...#.....#.#.......#.....#.....#...#.....#...#.#...#...#.#.....#.#.........#.....#...#...#.#.#
#.###$###.$.###$#.#.$####$####$.###$###.$##.#$####$.#.#$#.##$.###$####$.#.#$####$.###$#.##$##.#$#.#.#
#...#.....#.#...#...#...#.....#.#.#.......#.#.....#...#.#...#...#...#...#.#...#.#.#.....#.....#...#.#
#.#.#.#####.###.###.#.#.#.###.#.#.#.#######.#.###.#####.###.#.#.###.#.#.#.#.#.#.#.###.###.#####.###.#
#.#.#.....#...#...#.#.#.....#...#...#.......#...#...#...#...#.#.#...#.#.#.#.#...#...#.#.....#.#.#...#
#.#.#.#######.###.###.#####.#####.###.#########.#.#.#.###.#####.#.###.#.#.#.#######.#.#####.#.#.#.#.#
#.#..$#...$...#$#...$.#..$#...$...#$..#.$....$..#.$...#$..#.$...#$..#.$.#..$#...$...#$#...$.#.#$#.#.#
#.#####.#######.#######.#.#.#.#.###.###.#########.#.###.###.#######.#.#####.#.#######.#.#.#.#.#.#.#.#
#.#...#.....#.......#...#.#.#...#...#...#.......#.#.#.......#.......#.....#.#.....#.....#...#.#...#.#
#.#.#.#####.#.###.#.###.#.#.#####.#####.###.###.#.###.#######.#########.###.#####.###########.#####.#
#...#.#...#.#.#...#...#.#...#...#.....#...#...#.#.....#.#...#...#.#...#...#.#...#.......#...#.....#.#
#####$#.#.$.###$####$.###$###.$.###$#.##$.###$#.##$####$#.#.$##.#$#.#.$##.#$#.##$##.#$#.#.$##.#$###.#
#.....#.#.#...#.#...#.........#.....#.#.#.....#.........#.#.....#...#...#.#.#.#...#...#.#...#.#.....#
#.#####.#.###.#.#.#.###############.#.#.#####.#.#######.#.###########.#.#.#.#.#.#.#####.###.#.#######
#.#.#...#...#.#...#...#...#.......#...#.....#...#.#.....#.............#.#...#.#.#.#.....#...#.....#.#
#.#.#.#####.#.#####.#.#.#.#######.#####.###.#####.#.###############.#######.#.#.#.#.#####.#.#####.#.#
#.#.#$..#.$...#$..#.$.#.#$....$.#..$..#.$.#..$#...$.#..$....$....$#.#.$...#$..#.$...#$....$...#$..#.#
#.#.###.#.#####.#.###.#.#######.#.###.###.#.###.#####.#######.#####.#.###.#####.#####.#.#######.###.#
#.#...#.#.#.....#...#...#.......#...#.....#.#...#.....#.....#.......#.#...#...#...#...#...#...#.#...#
#.#.#.#.###.#######.#####.#.#######.#####.#.#.###.#####.#############.###.#.#.###.###.###.#.#.#.###.#
#.#.#.#.....#.#.....#.....#.#.....#.#...#.#...#...#...........#.#...#...#...#...#...#...#...#.#.#...#
#.#.#$####$##.#$####$.###$#.#.$##.#$#.#.$####$#.##$####$###.$.#.#$#.##$.###$###.$##.#$#.##$##.#$#.#.#
#.#.#...#.....#.....#...#.#.#.#.#.....#.#...#.#...........#.#.#...#...#.#...........#.#.....#...#.#.#
#.#####.#.#.#.#####.#.#.#.#.#.#.#######.#.#.###.#########.#.#.#####.#.#.#############.#####.#####.###
#.....#...#.#.....#.#.#.#...#.#.......#.#.#...#.#.......#.#.#.......#.#...........#.......#.....#...#
#####.#.###.#.#######.#.###.#.#.#####.#.#.###.#.#.#####.#.#.#######.#####.#######.#.###.#.#####.#.#.#
#...#$#...$.#.#$....$.#..$#.#.$....$#.#.$.#.#$..#.$...#$#...$....$#.#.$.#..$....$.#.#$..#.$...#$#.#.#
###.#.###.#.###.###.#.###.###.#######.#.#.#.#####.#.###.#######.###.#.#.#######.#.###.#.###.#.#.###.#
#...#.#...#...#...#.#...#...#.#.......#...#.....#.#.....#.......#...#.#.#.....#.#.#...#.#...#.#.#...#
#.#.#.#.#####.###.#.###.###.#.#.#####.#######.###.#.#####.#####.#.###.#.#####.#.#.#.#####.###.#.#.###
#.#.#.#.#...#.....#.....#.#...#.....#.........#...#...#.......#.#.#.#.#.....#...#.#.........#.#.#...#
#.###$#.#.$.###$####$##.#$####$####$###.$####$#.##$##.#$####$.###$#.#.$####$#.##$.#.#$####$##.#$###.#
#.....#...#.#.........#.....#.....#...#.#.......#...#.#.....#.......#.....#.#...#.#...#.....#...#...#
#.#######.###.#.#####.#####.#.###.#.#.###.#######.#.#.###################.#.###.#.#####.###.###.#.#.#
#...#...#.#...#.#...#.....#...#...#.#...#.......#.#.#.......#.......#.....#.#...#.....#.#.#...#...#.#
###.###.#.#.#####.#.#####.#######.#####.#######.#.#.#######.#.#####.#.#####.#.#######.#.#.###.#######
#.#..$#.#.$....$..#.$...#$....$.#..$#...$...#$..#.$....$#...$....$#...$....$#...$....$#.#.$.#.#$....#
#.###.#.#.#########.#.#########.###.#.#.#####.###.#.#####.#######.#####.#####.###.#####.###.#.#.###.#
#.....#.#...#...#...#...#.....#.#.....#.#.....#.#.#...............#...#...#...#...#.........#...#...#
#.#####.###.###.#.###.#.#.#.###.#########.#####.#.###################.###.###.#.###.#######.#####.###
#.#.......#.....#.#...#...#...#.#.......#.#...#...#.......#...........#.#...#.#.......#...#.....#...#
#.###$###.$.###$#.#.$####$#.#.$.#.#$###.$.#.#$####$.###$#.#.$.###$###.$.###$#.##$####$#.#.$.###$#.#.#
#.#...#...#.#.....#...#.....#.#...#...#.#.#.#.....#.....#.#.#.#...#.#...#...#...#...#...#.#.#...#.#.#
#.#.#.#.###.#.#######.#.#####.#####.###.#.#.#####.#####.#.###.#.#.#.#.###.#####.#.###.###.#.#.#.###.#
#...#.#.....#.#.....#...#...#.......#...#...#...#.....#.#...#.#.#.#...#...#...#.#...#.#.#.#.#.#.#...#
#####.#.#####.#.###.#.###.#.#####.#.#.###.###.#.#.#.###.###.#.#.#.###.#.###.###.###.#.#.#.#.#.#.#.#.#
#...#$#...$...#$..#.$.#..$#...$...#$#.#.$...#$#.#.$.#..$#.#.$...#$..#.$.#..$....$...#$#...$.#.#$..#.#
#.###.###.#.###########.###########.#.#####.#.#.###.#.###.#.#.#####.###.#.#########.#.#.###.#.#####.#
#...#...#.#.#...........#...#...#...#...#...#.#...#.#.....#.#.....#.....#.#...#.....#.#...#.#.#.#...#
#.#.###.###.#.#.#########.#.#.#.#.#####.#####.###.#.###.###.#####.#######.#.#.#######.###.###.#.#.###
#.#...#.....#.#.......#...#...#.#.#...#.......#...#...#.#...#...#...#.....#.#...#.....#.#...#.#...#.#
#.###$####$##.#$####$.#.#$####$.#.#$#.##$####$#.##$.#.#$#.##$.###$#.##$####$###.$.###$#.##$.#.#$###.#
#...#...#.#...#.....#...#.....#.#.............#.#.#.#...#.#...#...#...#.....#.#.#.....#...#...#...#.#
#.###.#.#.#.###.#####.#######.#.#############.#.#.#.#####.#.###.#.###.#.#####.#.#####.#.#.#######.#.#
#.#...#.#.#.#...#...#...#.....#.#...........#.#.#...#...#.#.....#...#...#...#.#.......#.#.......#.#.#
###.###.#.#.#.#.#.#.###.#.###.#.#.###########.#.###.#.#.#.###.#####.###.#.#.#.#########.#######.#.#.#
#...#$#.#.$.#.#$#.#.$...#$..#.$.#..$....$...#$#...$.#.#$#...$....$#...$...#$#...$....$....$....$#...#
#.###.#.#.#.#.###.#.###.###.#.#.#########.#.#.###.###.#.###.#####.###.#####.###.#.#########.###.###.#
#.#...#.#.#.#.#...#...#.....#.#.....#...#.#...#...#...#.....#.....#...#.......#.......#.....#.....#.#
#.#.###.#.#.#.#.#####.#######.#####.#.#.#######.###.#########.#####.#########.#######.#.#####.#####.#
#.#.....#.....#...#.........#.....#.#.#.......#.....#.........#.....#...#...#.......#.#.....#.#.....#
#.###$####$##.#$#.##$####$#.##$##.#$#.##$####$####$####$####$##.#$###.$.#.#$####$##.#$#.##$.###$#####
#...#.......#...#.......#.......#.#.#.#.....#.........#...#...#.......#...#.#.....#...#.#.#...#.#...#
#.#.#######.#.#####.###.#.#####.###.#.###.#####.#####.#####.#.#######.#####.#####.###.#.#.###.#.#.#.#
#.#.......#.#.#...#.#...#.#...#.....#...#.#.....#...#...#...#.#.....#.....#.#...#...#.#...#...#...#.#
#.#######.#.#.#.#.###.#.###.#.#####.###.#.#.#######.###.#.###.#.###.#######.#.#.###.#.###.#.#.#####.#
#...#$..#.$.#.#$#...$.#.#$..#.$....$#.#.$.#..$....$....$#.#.$.#..$#...$....$#.#.$.#..$#...$.#.#$....#
###.###.#.#.#.#.###.#.###.###.###.###.#.#.#######.###.###.#.#.#.#.#####.#####.###.#.#######.###.#####
#.....#.#.#.#.#...#.#.#...#.#...#.#...#.#...#...#...#.#...#...#.#.#...#.#.....#.#.#.......#...#.#...#
#####.#.#.#.#.###.#.#.#.###.###.#.#.###.#.#.#.#.###.#.#.#.#.###.#.#.#.###.#####.#.#######.###.#.#.#.#
#...#...#.#.#.#...#...#.#.....#.#.#...#...#.#.#.#...#.#.#.#...#.#...#...........#.......#.#...#.#.#.#
#.#.#$###.$.###$####$.#.#$###.$.#.#$#.##$##.#$###.$##.#$#.##$.###$###.$####$####$##.#$#.#.$.#.#$#.#.#
#.#.......#.....#.#...#.#.#...#.#.....#...#.#.#...#.......#...#.....#.#.#.....#...#.#...#...#.#.#.#.#
#.#####.#########.#.###.###.#.#.###.###.#.#.#.#.###########.###.###.#.#.#.###.#.#.###.#######.#.#.#.#
#.#...#.#...#...#...#.#.#...#.#.#...#...#...#.#.....#.....#...#.#...#...#.#.....#.#...#.......#...#.#
#.#.#.###.#.#.#.#.###.#.#.###.#.###.#.#######.#####.#.#.#.###.#.###.###.#.#######.#.###.###########.#
#.#.#$....$.#.#$#.#.$.#..$#...$...#$#.#.$....$#...$.#.#$#.#.$.#..$#...$.#..$#...$...#$#.#.$...#$....#
#.#.#######.#.###.#.#.#####.#####.###.#.#.###.#.#.#.###.###.#####.###.#####.#########.#.#.###.#.#####
#...#.......#.....#.#.#.....#...#.#...#.#.#.#...#.#...#...#.......#.........#...#.......#.#.#.#.....#
#.###.###########.#.###.#######.#.#.#####.#.#####.###.#.#.#########.#########.#.#######.#.#.#.#####.#
#.#.#.......#...#...#...#.....#.#.#.#.....#.#.....#.#.#.#...........#.........#.#.....#.#...#.....#.#
#.#.#$####$.#.#$###.$.###$###.$.#.#$#.##$##.#$####$.#.#$####$##.#$###.$####$###.$.###$###.$##.#$###.#
#.#.......#...#.#.#.#.#...#.....#.#.#.#...#...#.....#.........#...#.#.#...#.....#...#.....#...#.....#
#.#.###.#######.#.#.#.###.#######.#.#.#.#.#.###.###.#########.###.#.#.###.#.#######.#######.#.#.#####
#...#...#...#...#...#...#.#.....#.#...#.#.#...#.#.......#...#...#...#.#...#.#.......#.......#.#.....#
###.#####.#.#.###.#####.#.#.###.#.#####.#####.#.#######.#.#.#.#.#####.#.###.#.#######.#############.#
#...#$..#.$...#$....$...#$#.#.$...#$..#.$....$#...$.#..$#.#.$.#..$..#.$.#..$#.#.$...#$..#.$...#$....#
#.###.#.#.#########.#.###.#.#######.#.#.#######.#.#.#.###.#.#######.###.#.###.#.###.###.#.###.#.#####
#...#.#...#...#...#.#...#.#.#.......#...#.....#.#.#.#.#.#.#.........#...#...#.#...#.#.#.#.#...#.#...#
###.#.#####.#.#.#.#####.#.#.#.###########.###.###.#.#.#.#.###########.#####.#.###.#.#.#.#.#.###.#.#.#
#...#.......#...#.........#...............#.......#.....#.................#.......#...#...#.......#.#
#####################################################################################################`
  ).split('\n').map(l=>l.split(''));

  // Floor
  // vertices.push(0, 0, 0, 0, 0, maze1.length, maze1.length, 0, 0, 0, 0, maze1.length, maze1.length, 0, maze1.length, maze1.length, 0, 0);
  // colors.push(...Array(6).fill([102,140,255]).flat());
  // count += 1;

  maze1.forEach((row, i) => {
    row.forEach((cell, j) => {
      if (cell == '#') {
        walls.push([j,0,i]);
        let [x,y,z] = [j, 0, i];
        vertices.push(
          x, y, z, x, y+1, z, x+1, y, z, x, y+1, z, x+1, y+1, z, x+1, y, z,
          x, y, z+1, x+1, y, z+1, x, y+1, z+1, x, y+1, z+1, x+1, y, z+1, x+1, y+1, z+1,
          // x, y+1, z, x, y+1, z+1, x+1, y+1, z, x, y+1, z+1, x+1, y+1, z+1, x+1, y+1, z,
          // x, y, z, x+1, y, z, x, y, z+1, x, y, z+1, x+1, y, z, x+1, y, z+1,
          x, y, z, x, y, z+1, x, y+1, z, x, y, z+1, x, y+1, z+1, x, y+1, z,
          x+1, y, z, x+1, y+1, z, x+1, y, z+1, x+1, y, z+1, x+1, y+1, z, x+1, y+1, z+1,
        );
        colors.push(...[
          Array(6).fill([77,121,255]).flat(), // N
          Array(6).fill([50,100,255]).flat(), // S
          // Array(6).fill([0,64,255]).flat(), // T
          // Array(6).fill([0,0,0]).flat(), // B
          Array(6).fill([26,83,255]).flat(), // W
          Array(6).fill([26,83,255]).flat(), // E
        ].flat());
        texcoords.push(
          1, 0.25, 1, 0, 0, 0.25, 1, 0, 0, 0, 0, 0.25, // N
          0, 0.25, 1, 0.25, 0, 0, 0, 0, 1, 0.25, 1, 0, // S
          0, 0.25, 1, 0.25, 0, 0, 1, 0.25, 1, 0, 0, 0, // W
          1, 0.25, 1, 0, 0, 0.25, 0, 0.25, 1, 0, 0, 0, // E
        );
        count += 4;
      }
      if (cell == '.') {
        let [x,y,z] = [j, 0, i];
        vertices.push(
          x, y, z, x, y, z+1, x+1, y, z, x, y, z+1, x+1, y, z+1, x+1, y, z,
          x, y+1, z, x+1, y+1, z, x, y+1, z+1, x, y+1, z+1, x+1, y+1, z, x+1, y+1, z+1,
        );
        colors.push(...[
          Array(6).fill([102,140,255]).flat(), // B inward
          Array(6).fill([102,140,255]).flat(), // T inward
        ].flat());
        texcoords.push(
          0, 0.25, 0, 0.5, 1, 0.25, 0, 0.5, 1, 0.5, 1, 0.25, // B inward
          0, 0.75, 1, 0.75, 0, 0.5, 0, 0.5, 1, 0.75, 1, 0.5, // T inward
        );
        count += 2;
      }
      if (cell == '$') {
        elevators.push([j,i]);
        elevatorVs.push(count); // Record elevator position in array (count*18 (+ 1,4,7,10,13,16 for y-positions))
        let [x,y,z] = [j, 0, i];
        vertices.push(
          x, y, z, x, y, z+1, x+1, y, z, x, y, z+1, x+1, y, z+1, x+1, y, z,
          x, y-0.001, z, x, y-0.001, z+1, x+1, y-0.001, z, x, y-0.001, z+1, x+1, y-0.001, z+1, x+1, y-0.001, z,
          x, y+1, z+1, x, y+1.25, z+1, x+1, y+1, z+1, x, y+1.25, z+1, x+1, y+1.25, z+1, x+1, y+1, z+1,
          x, y+1, z, x+1, y+1, z, x, y+1.25, z, x, y+1.25, z, x+1, y+1, z, x+1, y+1.25, z,
          x+1, y+1, z, x+1, y+1, z+1, x+1, y+1.25, z, x+1, y+1, z+1, x+1, y+1.25, z+1, x+1, y+1.25, z,
          x, y+1, z, x, y+1.25, z, x, y+1, z+1, x, y+1, z+1, x, y+1.25, z, x, y+1.25, z+1,
        );
        colors.push(...[
          Array(6).fill([255,0,0]).flat(), // B inward (red)
          Array(6).fill([26,83,255]).flat(), // B inward (blue)
          Array(6).fill([0,64,255]).flat(), // S inward
          Array(6).fill([0,64,255]).flat(), // N inward
          Array(6).fill([0,64,255]).flat(), // E inward
          Array(6).fill([0,64,255]).flat(), // W inward
        ].flat());
        texcoords.push(
          0, 0.75, 0, 1, 1, 0.75, 0, 1, 1, 1, 1, 0.75, // B inward
          0, 0.25, 0, 0.5, 1, 0.25, 0, 0.5, 1, 0.5, 1, 0.25, // B inward
          1, 0.25, 1, 0.1875, 0, 0.25, 1, 0.1875, 0, 0.1875, 0, 0.25, // S inward
          0, 0.25, 1, 0.25, 0, 0.1875, 0, 0.1875, 1, 0.25, 1, 0.1875, // N inward
          0, 0.25, 1, 0.25, 0, 0.1875, 1, 0.25, 1, 0.1875, 0, 0.1875, // E inward
          1, 0.25, 1, 0.1875, 0, 0.25, 0, 0.25, 1, 0.1875, 0, 0.1875, // W inward
        );
        count += 6;
      }
    });
  });

  // Walls between levels
  let width = maze1.length;
  vertices.push(
    0, 1, 0, 0, 1.25, 0, width, 1, 0, 0, 1.25, 0, width, 1.25, 0, width, 1, 0,
    0, 1, width, width, 1, width, 0, 1.25, width, 0, 1.25, width, width, 1, width, width, 1.25, width,
    0, 1, 0, 0, 1, width, 0, 1.25, 0, 0, 1, width, 0, 1.25, width, 0, 1.25, 0,
    width, 1, 0, width, 1.25, 0, width, 1, width, width, 1, width, width, 1.25, 0, width, 1.25, width,
  );
  colors.push(...[
    Array(6).fill([77,121,255]).flat(), // N
    Array(6).fill([50,100,255]).flat(), // S
    Array(6).fill([26,83,255]).flat(), // W
    Array(6).fill([26,83,255]).flat(), // E
  ].flat());
  texcoords.push(
    width, 0.25, width, 0.1875, 0, 0.25, width, 0.1875, 0, 0.1875, 0, 0.25, // N
    0, 0.25, width, 0.25, 0, 0.1875, 0, 0.1875, width, 0.25, width, 0.1875, // S
    0, 0.25, width, 0.25, 0, 0.1875, width, 0.25, width, 0.1875, 0, 0.1875, // W
    width, 0.25, width, 0.1875, 0, 0.25, 0, 0.25, width, 0.1875, 0, 0.1875, // E
  );
  count += 4;

  maze2.forEach((row, i) => {
    row.forEach((cell, j) => {
      if (cell == '#') {
        walls.push([j,1,i]);
        let [x,y,z] = [j, 1.25, i];
        vertices.push(
          x, y, z, x, y+1, z, x+1, y, z, x, y+1, z, x+1, y+1, z, x+1, y, z,
          x, y, z+1, x+1, y, z+1, x, y+1, z+1, x, y+1, z+1, x+1, y, z+1, x+1, y+1, z+1,
          // x, y+1, z, x, y+1, z+1, x+1, y+1, z, x, y+1, z+1, x+1, y+1, z+1, x+1, y+1, z,
          // x, y, z, x+1, y, z, x, y, z+1, x, y, z+1, x+1, y, z, x+1, y, z+1,
          x, y, z, x, y, z+1, x, y+1, z, x, y, z+1, x, y+1, z+1, x, y+1, z,
          x+1, y, z, x+1, y+1, z, x+1, y, z+1, x+1, y, z+1, x+1, y+1, z, x+1, y+1, z+1,
        );
        colors.push(...[
          Array(6).fill([77,121,255]).flat(), // N
          Array(6).fill([50,100,255]).flat(), // S
          // Array(6).fill([0,64,255]).flat(), // T
          // Array(6).fill([0,0,0]).flat(), // B
          Array(6).fill([26,83,255]).flat(), // W
          Array(6).fill([26,83,255]).flat(), // E
        ].flat());
        texcoords.push(...[
          1, 0, 1, 0.25, 0, 0, 1, 0.25, 0, 0.25, 0, 0, // N
          0, 0, 1, 0, 0, 0.25, 0, 0.25, 1, 0, 1, 0.25, // S
          0, 0, 1, 0, 0, 0.25, 1, 0, 1, 0.25, 0, 0.25, // W
          1, 0, 1, 0.25, 0, 0, 0, 0, 1, 0.25, 0, 0.25, // E
        ]);
        count += 4;
      }
      if (cell == '.') {
        let [x,y,z] = [j, 1.25, i];
        vertices.push(
          x, y, z, x, y, z+1, x+1, y, z, x, y, z+1, x+1, y, z+1, x+1, y, z,
          x, y+1, z, x+1, y+1, z, x, y+1, z+1, x, y+1, z+1, x+1, y+1, z, x+1, y+1, z+1,
        );
        colors.push(...[
          Array(6).fill([102,140,255]).flat(), // B inward
          Array(6).fill([102,140,255]).flat(), // T inward
        ].flat());
        texcoords.push(
          0, 0.75, 0, 0.5, 1, 0.75, 0, 0.5, 1, 0.5, 1, 0.75, // B inward
          0, 0.25, 1, 0.25, 0, 0.5, 0, 0.5, 1, 0.25, 1, 0.5, // T inward
        );
        count += 2;
      }
      if (cell == '$') {
        let [x,y,z] = [j, 1.25, i];
        vertices.push(
          x, y+1, z, x+1, y+1, z, x, y+1, z+1, x, y+1, z+1, x+1, y+1, z, x+1, y+1, z+1,
        );
        colors.push(...[
          Array(6).fill([102,140,255]).flat(), // T inward
        ].flat());
        texcoords.push(
          0, 0.25, 1, 0.25, 0, 0.5, 0, 0.5, 1, 0.25, 1, 0.5, // T inward
        );
        count += 1;
      }
    });
  });

  setAttribute('a_position', new Float32Array(vertices), 3);
  setAttribute('a_color', new Uint8Array(colors), 3, true, gl.UNSIGNED_BYTE);
  setAttribute('a_texcoord', new Float32Array(texcoords), 2, true, gl.FLOAT);
  
  map1.canvas.style.display = minimapCheckbox.checked ? 'block' : 'none';
  map2.canvas.style.display = minimapCheckbox.checked ? 'block' : 'none';
  gl.uniform1f(gl.getUniformLocation(program, 'u_usingTexture'), textureCheckbox.checked);

  let texture = gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D, texture);
  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([128,0,0,255]));

  let image = new Image();
  image.src = "tex.png";
  image.addEventListener('load', () => {
    gl.bindTexture(gl.TEXTURE_2D, texture);
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
    gl.generateMipmap(gl.TEXTURE_2D);
  });

}

let example = true;
resetMazes(example);

const button = document.querySelector('button');
button.addEventListener('click', () => {
  button.blur();
  if (example) {
    button.textContent = 'Switch to practice maze';
  } else {
    button.textContent = 'Switch to full maze';
  }
  example = !example;
  resetMazes(example);
});

minimapCheckbox.addEventListener('change', () => {
  minimapCheckbox.blur();
  map1.canvas.style.display = minimapCheckbox.checked ? 'block' : 'none';
  map2.canvas.style.display = minimapCheckbox.checked ? 'block' : 'none';
});

textureCheckbox.addEventListener('change', () => {
  textureCheckbox.blur();
  gl.uniform1f(gl.getUniformLocation(program, 'u_usingTexture'), textureCheckbox.checked);
});

let then = 0;
requestAnimationFrame(function loop(now) {
  const dt = (now - then) / 1000 * 2; then = now;
  if (swapping) {
    if (ground) {
      position[1] += dt;
      for (let i of elevatorVs) {
        for (let j = 1; j < 18; j += 3) {
          vertices[i * 18 + j] += dt;
        }
      }
      if (position[1] >= 1.85) {
        position[1] = 1.85;
        for (let i of elevatorVs) {
          for (let j = 1; j < 18; j += 3) {
            vertices[i * 18 + j] = 1.25;
          }
        }
        swapping = false;
        ground = false;
      }
    } else {
      position[1] -= dt;
      for (let i of elevatorVs) {
        for (let j = 1; j < 18; j += 3) {
          vertices[i * 18 + j] -= dt;
        }
      }
      if (position[1] <= 0.6) {
        position[1] = 0.6;
        for (let i of elevatorVs) {
          for (let j = 1; j < 18; j += 3) {
            vertices[i * 18 + j] = 0;
          }
        }
        swapping = false;
        ground = true;
      }
    }
    setAttribute('a_position', new Float32Array(vertices), 3);
  } else {
    if (keys.has('ARROWLEFT') || keys.has('A')) {
      angle += dt;
    }
    if (keys.has('ARROWRIGHT') || keys.has('D')) {
      angle -= dt;
    }
    if (keys.has('ARROWUP') || keys.has('W')) {
      let newx =  position[0] + dt * Math.sin(angle);
      if (!walls.some(([j,k,i]) => Math.floor(newx) == j && Math.floor(position[1]) == k && Math.floor(position[2]) == i)) {
        position[0] = newx;
      }
      let newz =  position[2] + dt * Math.cos(angle);
      if (!walls.some(([j,k,i]) => Math.floor(position[0]) == j && Math.floor(position[1]) == k && Math.floor(newz) == i)) {
        position[2] = newz;
      }
    }
    if (keys.has('ARROWDOWN') || keys.has('S')) {
      let newx =  position[0] - dt * Math.sin(angle);
      if (!walls.some(([j,k,i]) => Math.floor(newx) == j && Math.floor(position[1]) == k && Math.floor(position[2]) == i)) {
        position[0] = newx;
      }
      let newz =  position[2] - dt * Math.cos(angle);
      if (!walls.some(([j,k,i]) => Math.floor(position[0]) == j && Math.floor(position[1]) == k && Math.floor(newz) == i)) {
        position[2] = newz;
      }
    }
    if (keys.has(' ') || keys.has('E')) {
      if (elevators.some(([j,i]) => Math.floor(position[0]) == j && Math.floor(position[2]) == i)) {
        keys.delete('E');
        keys.delete(' ');
        swapping = true;
        if (ground) {
          map1.canvas.classList.add('hidden');
          map2.canvas.classList.remove('hidden');
        } else {
          map1.canvas.classList.remove('hidden');
          map2.canvas.classList.add('hidden');
        }
      }
    }
  }

  let target = [position[0] + Math.sin(angle), position[1], position[2] + Math.cos(angle)];
  gl.uniform3fv(gl.getUniformLocation(program, 'u_cameraPosition'), new Float32Array(position));
  gl.uniform3fv(gl.getUniformLocation(program, 'u_cameraTarget'), new Float32Array(target));
  resizeCanvas();
  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
  gl.drawArrays(gl.TRIANGLES, 0, count * 6);

  if (!covered.some(([px, py, pz]) => Math.floor(position[0]) == px && Math.floor(position[1]) == py && Math.floor(position[2]) == pz)) {
    covered.push([Math.floor(position[0]),Math.floor(position[1]),Math.floor(position[2])]);
  }

  function drawMap(level) {
    const map = level ? map2 : map1
    map.canvas.width = map.canvas.clientWidth;
    map.canvas.height = map.canvas.clientWidth;
    let size = map.canvas.width / maze1.length;
    (level ? maze2 : maze1).forEach((row, i) => {
      row.forEach((cell, j) => {
        if (cell == '#') {
          map.fillStyle = '#0007';
          map.fillRect(j * size, i * size, size, size);
        }
        if (cell == '$') {
          map.fillStyle = '#f007';
          map.fillRect(j * size, i * size, size, size);
        }
      });
    });
    covered.forEach(([px,py,pz]) => {
      if (py != level) { return; }
      map.fillStyle = '#ff07';
      map.beginPath();
      map.arc((px+0.5) * size, (pz+0.5) * size, size/2, 0, 2 * Math.PI);
      map.fill();
    });
    map.fillStyle = '#0707';
    map.save();
    map.translate(position[0] * size, position[2] * size);
    map.rotate(-angle);
    map.beginPath();
    map.moveTo(0, -size/4);
    map.lineTo(size/3, -size/3);
    map.lineTo(0, size/4);
    map.lineTo(-size/3, -size/3);
    map.fill();
    map.restore();

    map.canvas.style.rotate = `${angle+Math.PI}rad`;
  }
  drawMap(0);
  drawMap(1);

  requestAnimationFrame(loop);
});
  </script>
</head>
<body>
  <aside>
    <button>Switch to full maze</button>
    <p><label><input type="checkbox" class="minimap" checked>Toggle minimap</label></p>
    <p><label><input type="checkbox" class="texture">Use textures</label></p>
    <p>Keys: WASD + E for elevator</p>
    <p>Or arrow keys + space</p>
    <p><a href="practice_maze.mp4">Watch a practice maze walkthough</a></p>
    <p><a href="full_maze.mp4">Watch a full maze walkthough</a></p>
  </aside>
  <canvas class="maze"></canvas>
  <canvas class="map1"></canvas>
  <canvas class="map2 hidden"></canvas>
</body>
</html>
